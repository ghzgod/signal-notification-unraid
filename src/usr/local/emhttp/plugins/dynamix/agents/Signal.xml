<?xml version="1.0" encoding="utf-8"?>
  <Agent>
    <Name>Signal</Name>
    <Variables>
      <Variable Help="Optional manual override. If a signal-cli container is detected above, you can leave this blank. Only fill this in if auto-detection does not find your instance (e.g. signal-cli is running on a remote server or a non-standard setup). [script src='/plugins/signal-notification/include/signal-enhance.js'][/script]" Desc="Signal-CLI URL Override" Default="">SIGNAL_CLI_URL</Variable>
      <Variable Help="The base64-encoded group ID. Use the Load Groups button to populate this from your signal-cli instance, or paste the group ID manually." Desc="Signal Group ID" Default="">GROUP_ID</Variable>
      <Variable Help="Specify the fields which are included in the title of the notification." Desc="Notification Title" Default="$SUBJECT">TITLE</Variable>
      <Variable Help="Specify the fields which are included in the message body of the notification." Desc="Notification Message" Default="$DESCRIPTION">MESSAGE</Variable>
    </Variables>
    <Script>
      <![CDATA[
      #!/bin/bash
      ############
      {0}
      ############

      SCRIPTNAME=$(basename "$0")
      LOG="/var/log/notify_${SCRIPTNAME%.*}"

      # Read API type and detected URL from config
      CFG="/boot/config/plugins/signal-notification/signal.cfg"
      API_TYPE="asamk"
      ACCOUNT_NUMBER=""
      DETECTED_URL=""
      if [ -f "$CFG" ]; then
        API_TYPE=$(grep -oP 'API_TYPE="\K[^"]*' "$CFG" 2>/dev/null || echo "asamk")
        ACCOUNT_NUMBER=$(grep -oP 'ACCOUNT_NUMBER="\K[^"]*' "$CFG" 2>/dev/null || echo "")
        DETECTED_URL=$(grep -oP 'DETECTED_URL="\K[^"]*' "$CFG" 2>/dev/null || echo "")
      fi

      # Use detected URL if SIGNAL_CLI_URL override is empty
      [[ -z "$SIGNAL_CLI_URL" ]] && SIGNAL_CLI_URL="$DETECTED_URL"

      if [[ -z "$SIGNAL_CLI_URL" ]] || [[ -z "$GROUP_ID" ]]; then
        echo "$(date) Signal-CLI URL or Group ID not configured." >> "$LOG"
        exit 1
      fi

      # Set defaults for quick testing
      [[ -z "${EVENT}" ]] && EVENT='Unraid Status'
      [[ -z "${SUBJECT}" ]] && SUBJECT='Notification'
      [[ -z "${DESCRIPTION}" ]] && DESCRIPTION='No description'
      [[ -z "${IMPORTANCE}" ]] && IMPORTANCE='normal'
      [[ -z "${TIMESTAMP}" ]] && TIMESTAMP=$(date +%s)

      FULL_MESSAGE="$(hostname): ${TITLE}
${MESSAGE}"

      MAX=3
      for ((i = 1; i <= "$MAX"; i++)); do
        if [[ "$API_TYPE" == "bbernhard" ]]; then
          # bbernhard/signal-cli-rest-api: POST /v2/send
          PAYLOAD=$(jq -n --arg num "$ACCOUNT_NUMBER" --arg gid "$GROUP_ID" --arg msg "$FULL_MESSAGE" \
            '{"number":$num,"recipients":[$gid],"message":$msg}')
          RET=$(curl -s -w "\n%{http_code}" -X POST "${SIGNAL_CLI_URL}/v2/send" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" 2>&1)
          HTTP_CODE=$(echo "$RET" | tail -1)
          BODY=$(echo "$RET" | sed '$d')
          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            break
          fi
          RET="HTTP $HTTP_CODE: $BODY"
        else
          # asamk/signal-cli: JSON-RPC
          PAYLOAD=$(jq -n --arg gid "$GROUP_ID" --arg msg "$FULL_MESSAGE" \
            '{"jsonrpc":"2.0","method":"send","params":{"groupId":$gid,"message":$msg},"id":1}')
          RET=$(curl -s -X POST "${SIGNAL_CLI_URL}/api/v1/rpc" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" 2>&1)
          if echo "$RET" | jq -e '.result.results[0].type == "SUCCESS"' > /dev/null 2>&1; then
            break
          fi
        fi
        {
          date
          echo "attempt ${i} of ${MAX}"
          echo "$RET"
        } >> "$LOG"
        [[ "$i" -eq "$MAX" ]] && logger -t "$SCRIPTNAME" -- "Failed sending Signal notification" && break
        sleep 2
      done
      ]]>
    </Script>
  </Agent>
